# .github/workflows/deploy-backend.yml
name: Build and Push Backend Docker Image

on:
  push:
    branches:
      - master
      - feat/wakeup_worker_mecanism
    paths:
      - "backend/**"
      - "Dockerfile"
      - "docker-compose.dev.yml"
      - ".github/workflows/deploy-backend.yml"

  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER_NAME }}
          service_account: ${{ vars.GCP_SA_EMAIL }}
          audience: https://github.com/${{ github.repository_owner }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Docker Image with Cache
        env:
          GCP_REGION: ${{ vars.GCP_REGION }}
          GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          AR_REPO_ID: ${{ vars.AR_REPO_ID }}
          IMAGE_NAME: fastapi-backend
        run: |
          TAG=${{ github.sha }}
          URL="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO_ID}/${IMAGE_NAME}"

          docker buildx build \
            --push \
            --cache-from type=gha \
            --cache-to   type=gha,mode=max \
            --tag         "$URL:$TAG" \
            --tag         "$URL:latest" \
            --file        ./Dockerfile \
            .

      - name: Deploy to Cloud Run
        env:
          GCP_REGION: ${{ vars.GCP_REGION }}
          GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          AR_REPO_ID: ${{ vars.AR_REPO_ID }}
          IMAGE_NAME: fastapi-backend
        run: |
          IMAGE_URL="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO_ID}/${IMAGE_NAME}:latest"
          gcloud run deploy fastapi-backend-dev \
            --image           "$IMAGE_URL" \
            --region          "$GCP_REGION" \
            --platform        managed \
            --service-account "${{ secrets.BACKEND_API_SA_EMAIL }}" \
            --project         "$GCP_PROJECT_ID" \
            --quiet
